@using aznews.Areas.Admin.Models
@using aznews.Areas.GiangVien.Models
@model AttendanceVM
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    var lop = ViewBag.Lop as LopHocPhan;
    ViewData["Title"] = "Điểm danh";

    // Helper to check checkbox by current status
    bool Checked(AttendanceStatus cur, AttendanceStatus target) => cur == target;
}

<section class="section">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body p-4">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold text-primary mb-0">
              Điểm danh – @lop?.HocPhan?.TenHP (@lop?.HocKy, @lop?.NamHoc)
            </h4>

            <form method="get" class="d-flex align-items-center gap-2">
              <input type="hidden" name="lopId" value="@Model.MaLHP" />
              <input type="date" name="ngay" value="@Model.Ngay.ToString("yyyy-MM-dd")" class="form-control" />
              <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-calendar-event"></i> Chọn ngày</button>
            </form>
          </div>

          @if (TempData["Success"] != null)
          {
              <div class="alert alert-success">@TempData["Success"]</div>
          }

          <form asp-area="GiangVien" asp-controller="DiemDanh" asp-action="Luu" method="post" id="dd-form">
            @Html.AntiForgeryToken()
            <input type="hidden" name="MaLHP" value="@Model.MaLHP" />
            <input type="hidden" name="Ngay" value="@Model.Ngay.ToString("yyyy-MM-dd")" />

            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light text-center">
                  <tr>
                    <th style="width:6%">#</th>
                    <th style="width:16%">Mã SV</th>
                    <th>Họ tên</th>
                    <th style="width:12%">Có phép</th>
                    <th style="width:12%">Muộn</th>
                    <th style="width:12%">Vắng</th>
                  </tr>
                </thead>
                <tbody>
                @{
                    var idx = 0;
                    var stt = 1;
                }
                @foreach (var row in Model.Entries)
                {
                  <tr>
                    <td class="text-center">@stt</td>
                    <td>@row.MaSoSV</td>
                    <td>@row.HoTen</td>

                    <!-- 3 checkbox: chỉ được chọn tối đa 1; nếu none => Có mặt -->
                    <td class="text-center">
                      <input type="checkbox" class="flag flag-cophep" data-index="@idx" @(Checked(row.TrangThai, AttendanceStatus.CoPhep) ? "checked" : "") />
                    </td>
                    <td class="text-center">
                      <input type="checkbox" class="flag flag-muon" data-index="@idx" @(Checked(row.TrangThai, AttendanceStatus.Muon) ? "checked" : "") />
                    </td>
                    <td class="text-center">
                      <input type="checkbox" class="flag flag-vang" data-index="@idx" @(Checked(row.TrangThai, AttendanceStatus.Vang) ? "checked" : "") />
                    </td>

                    <!-- Hidden fields bind về server -->
                    <input type="hidden" name="Entries[@idx].MaSinhVien" value="@row.MaSinhVien" />
                    <input type="hidden" name="Entries[@idx].MaSoSV" value="@row.MaSoSV" />
                    <input type="hidden" name="Entries[@idx].HoTen" value="@row.HoTen" />
                    <input type="hidden" name="Entries[@idx].TrangThai" value="@((byte)row.TrangThai)" class="status-val" data-index="@idx" />

                  </tr>
                  idx++; stt++;
                }
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Lưu điểm danh
              </button>
            </div>
          </form>

          <div class="mt-3 small text-muted">
            Quy ước: <strong>Không tích gì</strong> = <strong>Có mặt</strong>.  
            Nếu tích 1 trong 3 ô: <em>Có phép</em>, <em>Muộn</em>, hoặc <em>Vắng</em>, hệ thống tự đặt trạng thái tương ứng.
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

@section Scripts {
<script>
  // Chỉ cho phép tối đa 1 checkbox/row; sync vào hidden Entries[i].TrangThai
  // 0: Có mặt (mặc định), 1: Có phép, 2: Muộn, 3: Vắng
  function setStatusForIndex(i) {
    const coPhep = document.querySelector(`.flag-cophep[data-index='${i}']`);
    const muon   = document.querySelector(`.flag-muon[data-index='${i}']`);
    const vang   = document.querySelector(`.flag-vang[data-index='${i}']`);
    const hidden = document.querySelector(`.status-val[data-index='${i}']`);

    let val = 0; // default: Có mặt
    if (coPhep.checked)      val = 1;
    else if (muon.checked)   val = 2;
    else if (vang.checked)   val = 3;

    hidden.value = val;
  }

  function uncheckOthersAndSet(i, cls) {
    const group = [".flag-cophep", ".flag-muon", ".flag-vang"];
    group.forEach(c => {
      if (c !== cls) {
        const cb = document.querySelector(`${c}[data-index='${i}']`);
        cb.checked = false;
      }
    });
    setStatusForIndex(i);
  }

  // attach events
  document.querySelectorAll('.flag-cophep').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const i = e.target.getAttribute('data-index');
      uncheckOthersAndSet(i, '.flag-cophep');
    });
  });
  document.querySelectorAll('.flag-muon').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const i = e.target.getAttribute('data-index');
      uncheckOthersAndSet(i, '.flag-muon');
    });
  });
  document.querySelectorAll('.flag-vang').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const i = e.target.getAttribute('data-index');
      uncheckOthersAndSet(i, '.flag-vang');
    });
  });

  // Trước khi submit: đảm bảo mọi dòng đều sync hidden đúng (kể cả không click gì)
  document.getElementById('dd-form').addEventListener('submit', function() {
    document.querySelectorAll('.status-val').forEach(h => {
      const i = h.getAttribute('data-index');
      setStatusForIndex(i);
    });
  });
</script>
}
